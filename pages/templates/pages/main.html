<!DOCTYPE html>
<html>
<head>
    <title>íˆì„œë¸Œí† ë¦¬ - ì—­ì‚¬ ì—¬í–‰</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .station-btn { padding: 10px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 5px; }
        .station-btn:hover { background-color: #f0f0f0; }
        #display-area { margin-top: 20px; padding: 20px; border: 1px dashed #333; min-height: 200px; background-color: #fafafa; }
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .episode-img { width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .caption { font-size: 0.8em; color: #666; text-align: center; }
        
        /* í—¤ë” ë§í¬ ìŠ¤íƒ€ì¼ */
        .logo-link { text-decoration: none; color: inherit; }
        .logo-link:hover { opacity: 0.8; }
        nav { background: #f8f9fa; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>
        <a href="{% url 'main' %}" class="logo-link">ğŸš‡ íˆì„œë¸Œí† ë¦¬: ì§€í•˜ì²  ì—­ì‚¬ ì—¬í–‰</a>
    </h1>

    <nav>
        {% if user.is_authenticated %}
            <p>
                <strong>{{ user.nickname|default:user.username }}</strong>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! 
                <a href="{% url 'mypage' %}"><button style="cursor:pointer; padding:5px 10px;">ë‚´ ë³´ê´€í•¨(ë§ˆì´í˜ì´ì§€)</button></a> | 
                
                <form action="{% url 'logout' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" style="cursor:pointer; padding:5px 10px;">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </p>
        {% else %}
            <p>
                <a href="{% url 'login' %}">ë¡œê·¸ì¸</a> | 
                <a href="{% url 'signup' %}">íšŒì›ê°€ì…</a>
            </p>
        {% endif %}
    </nav>
    <hr>

    <h2>ğŸ›¤ï¸ ë…¸ì„  ì„ íƒ</h2>
    <form method="get">
        <select name="line" onchange="this.form.submit()">
            {% for l in lines %}
                <option value="{{ l }}" {% if l == line %}selected{% endif %}>{{ l }}</option>
            {% endfor %}
        </select>
    </form>

    <h2>ğŸ“ ì—­ ëª©ë¡ (ì—­ì„ í´ë¦­í•´ ë³´ì„¸ìš”!)</h2>
    <div id="station-list">
        {% for station in stations %}
            <button class="station-btn" onclick="selectStation(event, {{ station.id }})">
                {{ station.name }}
            </button>
        {% endfor %}
    </div>

    <div id="display-area">
        <h3 id="episode-title">ì—­ì„ ì„ íƒí•˜ë©´ ì´ì•¼ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</h3>
        <p id="episode-summary"></p>
        <div id="image-container" class="image-grid"></div>
        <div id="action-button" style="margin-top: 15px;"></div>
    </div>

    <script>
        // ì—í”¼ì†Œë“œ ì„ íƒ ë° ìƒì„±
        async function selectStation(event, sId) {
            const title = document.getElementById('episode-title');
            const summary = document.getElementById('episode-summary');
            const container = document.getElementById('image-container');
            const actionBtn = document.getElementById('action-button');

            title.innerText = "â³ ìƒì„± ì¤‘...";
            summary.innerText = "AIê°€ ì—­ì‚¬ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. (30ì´ˆ ì†Œìš”)";
            container.innerHTML = '';
            actionBtn.innerHTML = '';

            try {
                const response = await fetch(`/api/stories/select/${sId}/`);
                const data = await response.json();

                if (response.ok) {
                    title.innerText = data.title;
                    summary.innerText = data.history_summary;
                    
                    data.images.forEach(img => {
                        const div = document.createElement('div');
                        div.innerHTML = `<img src="${img.url}" class="episode-img"><p class="caption">${img.caption}</p>`;
                        container.appendChild(div);
                    });

                    // ì €ì¥ ë²„íŠ¼ ì¶”ê°€
                    actionBtn.innerHTML = `<button onclick="saveStory(${data.id})" style="padding:10px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">â­ ë³´ê´€í•¨ì— ì €ì¥</button>`;
                }
            } catch (e) {
                title.innerText = "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                console.error(e);
            }
        }

        // ì´ì•¼ê¸° ì €ì¥
        async function saveStory(epId) {
            const res = await fetch(`/api/library/save/${epId}/`, { 
                method: 'POST', 
                headers: {'X-CSRFToken': '{{ csrf_token }}'} 
            });
            const json = await res.json();
            alert(json.message);
            // ì €ì¥ í›„ ë³„ë„ì˜ í”¼ë“œë°±ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        }
    </script>
</body>
</html>